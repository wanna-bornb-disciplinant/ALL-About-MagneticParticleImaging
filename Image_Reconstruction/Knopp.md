| Paper Name | Year | Publication Venue | Author(1st & Corr.) | Short Summary | Item Number | 
|------|------|------|------|------|------|
| Online reconstruction of 3D magnetic particle imaging data | 2016 | Physics in Medicine & Biology | T Knopp and M Hofmann | 伪实时的在线MPI重建框架(延迟约为2s，边测量数据边成像) |2016.1 | 
| Weighted iterative reconstruction for magnetic particle imaging | 2010 | Physics in Medicine & Biology | T Knopp, T M Buzug | 线性重建问题中引入权重矩阵+频率筛选+迭代算法提升重建质量 | 2010.1 | 

* **#2016.1**
  这篇文章的噱头很足，因为在临床场景下实时成像是必需的手段，因此如果从重建的角度来讲，这篇文章没有什么新东西，但这个方向很重要。
    
  2015年MPI的第一台商业设备问世，标志着MPI技术进入临床前研究状态，但在真实的临床场景中，offline的重建会使得在临床阶段没有及时的信息反馈，因此需要构建一个online的重建框架，以文章中的成像场景为例，采集数据帧数可达46帧/秒，意味着需要较快的重建速度与之配合，以往的很多研究没有考虑在线重建主要是因为MPI技术还在萌芽阶段，很多研究主要围绕灵敏度和空间分辨率，这可以称之为实验室场景下的成像性能研究，因此本文的出发点主要围绕在线重建，这是他主要区别于其他文章的地方。
  
  文章使用**基于系统矩阵**的方式进行重建，在系统矩阵可以存储在内存中的情况下基于系统矩阵的方法有一定的计算速度优越性。同时虽然笛卡尔轨迹在基于FFP和基于FFL的成像中都有很好的表现，但无法胜任实时成像的任务，在多维的情况下，只能使用**丽萨荣轨迹**进行实验。构建系统矩阵的线性方程组后，使用Rahmer 2012 TMI的方法计算得到单一频率下的SNR值，**对系统矩阵的行做进一步减少，注意这里减少频率的操作需要慎重，因为频率少噪声也少，但指导重建的数据也少，同时在这样一个在线重建框架中，矩阵的行数也直接决定了重建算法的执行时间**。这里使用的Kaczmarz算法是在MPI系统矩阵的病态程度较高的基础上进行改进的，这里引入了一篇新的文章"Weighted iterative reconstruction for magnetic particle imaging, Physics in Medicine & Biology,T Knoppm, 2010"

  离线图像重建中更注重优化图像质量而忽略了相当程度的重建时间和算力消耗，但在在线图像重建框架中的重点就是低延迟可视化，这需要重建过程的短时间和低延迟。同时数据采集过程的速度会比重建过程更快，因此在这样的情况下实现低延迟的关键想法是**避免逐帧处理数据，始终重建最新的帧，预加载系统矩阵到主存中，并直接将重建数据显示在屏幕上，并不写入磁盘**，一个丢弃帧的替代方案就是平均数据，即将一个范围内的电压做平均，在平均电压信号上解决重建问题。

  可视化有多种解决方案，可以做体渲染、表面渲染和显示体切片，文中不需要有一个很强的交互性(但实际应用肯定是需要类似体渲染之类的效果)，因此这篇文章选择的是矢状、冠状和横向三个方向的最大投影图像，同时可视化界面中还有一个显示当前帧最大浓度的曲线图。
  
  硬件部分没有什么好说的，成像大小为
  $37.3 * 37.3 * 18.6 mm^3$。

  重建的实验中对比了通过SNR筛选不同比例的系统矩阵行参与重建的结果，使用3次Kaczmarz迭代+0.001的正则化系数(会根据矩阵的迹做一个线性的调整)，简化矩阵的大小介于完整矩阵大小的2.5%和80%之间。

  结果也没什么好说的，在简化矩阵的比例很小时，此时高频的部分会出现模糊，同时重建速度有很大的加快，文章中能做到0.3帧/秒-10帧/秒。

* **#2010.1**     
  成像场景为2D，文章中提到了在"Gleich B, Weizenecker J and Borgert J 2008 Experimental results on fast 2D-encoded magnetic particle imaging Phys. Med. Biol."中分析了一个现象，即对系统矩阵的行做归一化(同时对相应的测量信号也做相同的处理)会产生"更锐利但更多噪声"的图像，但相关文章并没有具体分析归一化是否对图像重建质量有提升。所以本文的出发点在于具体分析线性系统中的行加权对图像质量的实际影响，同时权重的引入还让迭代算法的收敛变得更快。

  重建前的准备，将多个频道的电压信号像堆栈一样垂直放置，且系统矩阵是通过测量得到的。

  重建的数学问题的描述(其实推导很简单，可以参照2012年的综述重建部分)：

  ![../pics/11.png](../pics/11.png)

  图中标黄和标红的地方是重点，请注意在改写成公式(6)的情况时，因为被共轭转置的矩阵列满秩，因此公式(6)必有阶且拥有唯一解，本文既然在研究权重矩阵和频率筛选，那么正则化参数可以在特定的组合下使用L-Curve来确定，因此可以分开来考虑。

  既然要分析如何取值权重矩阵和频率筛选，需要从系统矩阵的结构进行分析，**文章中的figure1分析了一些特定频率下的空间模式和各频率的系统矩阵行能量折线图，文章得到的结论和2009年Rahmer组对系统函数的分析类似：在某一方向上的纯谐波频率呈现出线性增长的空间频率，但在一些中间频率(其实就是混合阶数不低的情况下)反而会出现一些高空间频率的现象；但如果我们只考虑空间频率，可以说粒子浓度的细节信息全部在高空间频率的频率分量中，而一般结构信息会在低空间频率的频率分量中；不同的空间频率之间还具有一定的正交性(和第二类切比雪夫多项式挂钩)；能量图中有两个现象，一个是能量的总体趋势是逐渐降低，一个是以两个频道的驱动场为例，每次出现的波峰都会出现在
  $$n * \frac{(f_x+f_y)}{2}$$，同时出现波峰的两侧能量会快速下降；总的来说，低空间频率的频率分量拥有高能量，而高空间频率的频率分量拥有低能量**

  轮到实际的权重矩阵选择和频率筛选，权重矩阵取为单位矩阵是有一定的道理的，因为你可以很自然地认为SNR高的频率分量(能量高，且假定噪声为高斯白噪声，则SNR的分母相同)就应该为粒子信号贡献的更多；但根据我们之前的分析，**很明显行能量高的频率分量都对应的是低空间分辨率的部分，因此如果希望获得高分辨率的图像，应该对所有的频率分量做归一化，权重矩阵在计算范数时矩阵乘法的对象时权重矩阵的1/2次方，因此权重矩阵取为响应的对角元素为该行的行能量的平方的导数**，如果取非均匀的权重，SNR就无法保证，因此需要在使用非均匀权重时去除具有低SNR的频率分量，文章中的做法是取一个SNR阈值，低于这个阈值的系统矩阵行都被去除。

  在这篇文章中，我们尽量把CGLS和Kaczmarz这两种传统算法的来龙去脉都讲清楚：

  **首先是CGLS(在MPI中很多组会将其称为CGNR，本身作为CG算法的变种，解决最小二乘解的问题)**，CGLS的核心是解决最小二乘解问题时，如果系统矩阵满足列满秩(其实当我们引入正则化项写成一个大的系统矩阵之后都可以满足这一点)，最小二乘解可以转换为一个半正定矩阵的线性问题：

  下图左边表示的最传统的CG共轭梯度法，通过指定开始的方向进而不断用共轭的性质推导得到，下图右边是针对其中几步运算开销比较大的做了一定的改进：

  ![../pics/12.png](../pics/12.png)

  上式的推导可以给出：

  ![../pics/1.jpg](../pics/1.jpg)

  CGLS和CG的关联如下，这样引入额外辅助向量的目的就是避免M(即A的共轭转置乘上A的矩阵乘法这样的复杂运算)的出现：

  ![../pics/13.png](../pics/13.png)

  这里我们在MPI的正问题中引入了权重矩阵和正则化项，可以在最小二乘法的系统矩阵构建中将上述部分考虑进去，改写后的最终系统矩阵满足列满秩的特点，此时也需要对CGLS做一定的改写(推导可以结合2012综述中对系统矩阵的改写+CGLS的步骤)(下面的第一张图是MPI中的CGNR算法步骤，这张图中的A莫名其妙，其实就是S，第二张图是MPI步骤和CGLS标准步骤的对比证明)：

  ![../pics/14.png](../pics/14.png)

  ![../pics/2.jpg](../pics/2.jpg)

  **值得说明的是，上述公式中的初步残差向量r的定义是去除正则化项+去除权重矩阵的平方根部分得到的，去除平方根会在每一步计算对应的z的时候补足，不会影响和原始CGLS的结果区别，但我认为一个改进点在于应该将正则化考虑进去，理由在于后续关于CG的计算优化的三步都是建立在初始方向是最速下降中梯度的反向才能得到的，后续会在自己的代码中改正**

  CGLS在文章中有两个特性，这里我们不加以证明，只说明细节即可：1. 如果CGNR算法的初始浓度为0，则仅需一次迭代就能获得比较好的效果，Knopp组之前在MRI中的工作说明了这一点，当系统矩阵行(各频率分量)垂直时，下面的一步迭代结果就是正则化+权重矩阵引入的最小二乘法结果，当频率分量近似垂直时，一步迭代结果也是真实解的良好近似；2. CGNR算法的收敛速度和引入权重矩阵的
  $S^{H}WS$的条件数相关，因此希望权重矩阵引入后的系统矩阵拥有行垂直的特性，这有助于算法的快速收敛

  ![../pics/15.png](../pics/15.png)

  **第二种常见算法是Kaczmarz算法**，CT中常将其称为ART算法。Kac的算法思想其实很简单，就是以系统矩阵的行作为迭代的基本单位，每次在原来浓度的基础上增加一个距离下一个频率分量的子空间最近的空间变化量，下图是Kac的核心迭代公式，左图是实数域的ART，右图是MPI中复数域的ART，**区别在于切换到复数域时ART的每步迭代方向也变成了系统矩阵行的共轭**：

  ![../pics/16.png](../pics/16.png)

  MPI中对Kac的改进在于对于MPI的数据保真项那样的原始系统矩阵，无法保证确实有解，这被称为非一致系统，无解的情况Kac会在一个范围内振荡更新，因此做出的改进是将系统矩阵改写，具体如下，这样改写的系统矩阵满足行满秩的特性，线性方程组保证有解：

  ![../pics/17.png](../pics/17.png)

  有了上面的核心迭代过程，MPI中的Kac的伪代码如下(推导很容易，改写系统矩阵的效果在某种程度上等同于对重建问题做了正则化处理)：

  ![../pics/18.png](../pics/18.png)

  实验细节：使用的'Weizenecker J, Gleich B, Rahmer J, Dahnke H and Borgert J 2009 Three-dimensional real-time in vivo magnetic particle imaging Phys. Med. Biol.'这篇文章中的设备，本来有3D扫描功能但没用，系统矩阵大小为2536*2720，使用经典的斜'P'Phantom，文中展示了几个实验结果，一个是**前600行系统矩阵行的点积计算结果(共轭点乘，考虑了权重矩阵的参与，归一化处理)**，结果还是很令人满意，测量得到的系统矩阵拥有比较垂直的系统矩阵行效果，这里还对比了没有引入权重矩阵的点积结果，权重矩阵的加入会使结果好很多；一个是**引入权重矩阵的系统矩阵的奇异值计算**，归一化权重的加入能有效的增大较小的奇异值，使得矩阵的病态程度有所缓解；一个是通过SVD求解最小二乘法结果，对比的是不同的SNR阈值选择和不同的权重矩阵选择；一个是**通过Kac和CGNR两种迭代算法求解的SNR大于10的不同权重矩阵设置的重建结果对比**，使用归一化权重的方案在成像质量和成像速度上都有所提升，总的来说，Kaczmarz还是会优于CGNR。

  

  
  
    

  

